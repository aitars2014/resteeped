<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resteeped Admin</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #333; line-height: 1.6; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    header { background: #2d5016; color: white; padding: 20px; margin-bottom: 20px; }
    header h1 { font-size: 1.5rem; }
    .header-top { display: flex; justify-content: space-between; align-items: center; }
    .nav { display: flex; gap: 20px; margin-top: 10px; flex-wrap: wrap; }
    .nav a { color: white; text-decoration: none; opacity: 0.8; cursor: pointer; padding-bottom: 2px; }
    .nav a:hover, .nav a.active { opacity: 1; border-bottom: 2px solid white; }
    .logout-btn { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; }
    .logout-btn:hover { background: rgba(255,255,255,0.3); }
    .card { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .card h2 { margin-bottom: 15px; color: #2d5016; }
    .card h3 { margin: 20px 0 10px; color: #333; font-size: 1.1rem; }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
    .stat { background: #f8f9fa; padding: 15px; border-radius: 6px; text-align: center; }
    .stat .number { font-size: 2rem; font-weight: bold; color: #2d5016; }
    .stat .label { font-size: 0.9rem; color: #666; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
    th { background: #f8f9fa; font-weight: 600; }
    .btn { display: inline-block; padding: 8px 16px; background: #2d5016; color: white; border: none; border-radius: 4px; cursor: pointer; text-decoration: none; font-size: 0.9rem; margin-right: 5px; margin-bottom: 5px; }
    .btn:hover { background: #3d6a1e; }
    .btn-secondary { background: #6c757d; }
    .btn-danger { background: #dc3545; }
    .btn-small { padding: 4px 10px; font-size: 0.8rem; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: #2d5016; }
    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; }
    .badge-success { background: #d4edda; color: #155724; }
    .badge-warning { background: #fff3cd; color: #856404; }
    .badge-info { background: #cce5ff; color: #004085; }
    .hidden { display: none; }
    #loading { text-align: center; padding: 40px; }
    .error-msg { color: #dc3545; padding: 20px; text-align: center; }
    .toast { position: fixed; bottom: 20px; right: 20px; padding: 15px 20px; background: #333; color: white; border-radius: 4px; opacity: 0; transition: opacity 0.3s; z-index: 1000; }
    .toast.show { opacity: 1; }
    .section { display: none; }
    .section.active { display: block; }
    .tea-result { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    .tea-result:hover { background: #f8f9fa; }
    .tea-info { flex: 1; }
    .tea-name { font-weight: 500; }
    .tea-meta { font-size: 0.85rem; color: #666; }
    .filter-bar { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 6px; }
    .filter-bar select, .filter-bar input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    .collection-teas { margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 6px; }
    .collection-tea-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e0e0e0; }
    .collection-tea-item:last-child { border-bottom: none; }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="header-top">
        <h1>üçµ Resteeped Admin</h1>
        <button class="logout-btn" id="logout-btn">Logout</button>
      </div>
      <nav class="nav" id="nav">
        <a data-section="dashboard" class="active">Dashboard</a>
        <a data-section="collections">Collections</a>
        <a data-section="featured">Featured Shops</a>
        <a data-section="totd">Tea of the Day</a>
      </nav>
    </div>
  </header>

  <div class="container">
    <div id="loading">Loading...</div>
    <div id="error" class="error-msg hidden"></div>

    <!-- Dashboard -->
    <div id="dashboard" class="section">
      <div class="card">
        <h2>Overview</h2>
        <div class="stats">
          <div class="stat"><div class="number" id="stat-teas">-</div><div class="label">Total Teas</div></div>
          <div class="stat"><div class="number" id="stat-companies">-</div><div class="label">Tea Companies</div></div>
          <div class="stat"><div class="number" id="stat-collections">-</div><div class="label">Collections</div></div>
          <div class="stat"><div class="number" id="stat-featured">-</div><div class="label">Featured Shops</div></div>
        </div>
      </div>
    </div>

    <!-- Collections -->
    <div id="collections" class="section">
      <div class="card">
        <h2>Collections</h2>
        <p>Create curated lists of teas that appear in the app.</p>
        <button class="btn" id="new-collection-btn">+ New Collection</button>
        
        <div id="collection-form" class="hidden" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
          <h3 id="collection-form-title">New Collection</h3>
          <input type="hidden" id="collection-edit-id">
          <div class="form-row">
            <div class="form-group"><label>Title</label><input type="text" id="collection-title" placeholder="Morning Picks"></div>
            <div class="form-group"><label>Subtitle</label><input type="text" id="collection-subtitle" placeholder="Start your day right"></div>
            <div class="form-group"><label>Icon (Feather)</label><input type="text" id="collection-icon" placeholder="sun, coffee, heart"></div>
          </div>
          <button class="btn" id="save-collection-btn">Save</button>
          <button class="btn btn-secondary" id="cancel-collection-btn">Cancel</button>
        </div>

        <table id="collections-table" style="margin-top: 20px;">
          <thead><tr><th>Title</th><th>Subtitle</th><th>Teas</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Add Teas to Collection -->
      <div id="collection-teas-panel" class="card hidden">
        <h2>Manage Teas in: <span id="collection-teas-title"></span></h2>
        <input type="hidden" id="collection-teas-id">
        
        <h3>Current Teas</h3>
        <div id="collection-current-teas"></div>
        
        <h3>Add Teas</h3>
        <div class="filter-bar">
          <input type="text" id="collection-tea-search" placeholder="Search teas..." style="flex: 1; min-width: 200px;">
          <select id="collection-tea-type"><option value="">All Types</option></select>
          <select id="collection-tea-company"><option value="">All Companies</option></select>
        </div>
        <div id="collection-tea-results" style="max-height: 400px; overflow-y: auto;"></div>
        <button class="btn btn-secondary" id="close-collection-teas-btn" style="margin-top: 15px;">Done</button>
      </div>
    </div>

    <!-- Featured Shops -->
    <div id="featured" class="section">
      <div class="card">
        <h2>Featured Shops</h2>
        <p>Highlight tea companies on the home screen.</p>
        <button class="btn" id="new-featured-btn">+ Add Featured Shop</button>
        
        <div id="featured-form" class="hidden" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
          <div class="form-row">
            <div class="form-group"><label>Company</label><select id="featured-company"></select></div>
            <div class="form-group"><label>Start Date</label><input type="date" id="featured-start"></div>
            <div class="form-group"><label>End Date</label><input type="date" id="featured-end"></div>
          </div>
          <div class="form-group"><label><input type="checkbox" id="featured-exclusive"> Exclusive placement (only this shop during period)</label></div>
          <button class="btn" id="save-featured-btn">Save</button>
          <button class="btn btn-secondary" id="cancel-featured-btn">Cancel</button>
        </div>

        <table id="featured-table" style="margin-top: 20px;">
          <thead><tr><th>Company</th><th>Period</th><th>Exclusive</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Tea of the Day -->
    <div id="totd" class="section">
      <div class="card">
        <h2>Tea of the Day</h2>
        <p>Set a featured tea for any date.</p>
        
        <div class="form-row" style="max-width: 600px;">
          <div class="form-group"><label>Select Date</label><input type="date" id="totd-date"></div>
          <div class="form-group">
            <label>Current Selection</label>
            <div id="totd-current" style="padding: 10px; background: #f8f9fa; border-radius: 4px; min-height: 40px;">
              <span id="totd-tea-name">None set</span>
            </div>
          </div>
        </div>

        <h3>Find a Tea</h3>
        <div class="filter-bar">
          <input type="text" id="totd-search" placeholder="Search by name..." style="flex: 1; min-width: 200px;">
          <select id="totd-type"><option value="">All Types</option></select>
          <select id="totd-company"><option value="">All Companies</option></select>
          <select id="totd-caffeine">
            <option value="">Any Caffeine</option>
            <option value="none">Caffeine-Free</option>
            <option value="low">Low Caffeine</option>
            <option value="medium">Medium Caffeine</option>
            <option value="high">High Caffeine</option>
          </select>
        </div>
        <div id="totd-results" style="max-height: 500px; overflow-y: auto;"></div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var SUPABASE_URL = 'https://pakfofausiltnkojafpd.supabase.co';
      var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBha2ZvZmF1c2lsdG5rb2phZnBkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwODA0MDAsImV4cCI6MjA4NTY1NjQwMH0.PiFkQXWOZGmago4Qo7R7AnB7av6C-u4VOQKSQjQxoSg';
      
      var supabase, companies = [], teaTypes = [], allTeas = [];

      if (typeof window.supabase === 'undefined') { showError('Failed to load Supabase'); return; }
      try { supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); } 
      catch (e) { showError('Failed to init: ' + e.message); return; }

      // Helpers
      function showToast(msg) {
        var t = document.getElementById('toast');
        t.textContent = msg; t.classList.add('show');
        setTimeout(function() { t.classList.remove('show'); }, 3000);
      }
      function showError(msg) {
        document.getElementById('loading').classList.add('hidden');
        var e = document.getElementById('error');
        e.textContent = msg; e.classList.remove('hidden');
      }
      function sortName(name) {
        return name.toLowerCase().replace(/^the\s+/i, '');
      }

      // Logout
      document.getElementById('logout-btn').onclick = function() {
        fetch('/admin', { headers: { 'Authorization': 'Basic ' + btoa('logout:logout') } })
          .finally(function() { window.location.href = '/admin?logout=' + Date.now(); });
      };

      // Navigation
      document.querySelectorAll('#nav a').forEach(function(link) {
        link.onclick = function(e) {
          e.preventDefault();
          var section = this.getAttribute('data-section');
          if (!section) return;
          document.querySelectorAll('#nav a').forEach(function(l) { l.classList.remove('active'); });
          this.classList.add('active');
          document.querySelectorAll('.section').forEach(function(s) { s.classList.remove('active'); });
          document.getElementById(section).classList.add('active');
          document.getElementById('collection-teas-panel').classList.add('hidden');
        };
      });

      // Initialize
      async function init() {
        try {
          var [teasRes, companiesRes, typesRes] = await Promise.all([
            supabase.from('teas').select('id, name, type, caffeine_level, company_id', { count: 'exact' }),
            supabase.from('companies').select('*'),
            supabase.from('teas').select('type').not('type', 'is', null)
          ]);

          allTeas = teasRes.data || [];
          companies = (companiesRes.data || []).sort(function(a, b) { return sortName(a.name).localeCompare(sortName(b.name)); });
          
          var typeSet = {};
          (typesRes.data || []).forEach(function(t) { if (t.type) typeSet[t.type] = true; });
          teaTypes = Object.keys(typeSet).sort();

          document.getElementById('stat-teas').textContent = teasRes.count || 0;
          document.getElementById('stat-companies').textContent = companies.length;

          populateFilters();
          populateCompanySelect();

          var [collectionsRes, featuredRes] = await Promise.all([
            supabase.from('collections').select('*, collection_teas(id)'),
            supabase.from('featured_shops').select('*, companies(*)')
          ]);
          
          document.getElementById('stat-collections').textContent = (collectionsRes.data || []).length;
          document.getElementById('stat-featured').textContent = (featuredRes.data || []).length;
          renderCollections(collectionsRes.data || []);
          renderFeatured(featuredRes.data || []);

          document.getElementById('loading').classList.add('hidden');
          document.getElementById('dashboard').classList.add('active');
          document.getElementById('totd-date').value = new Date().toISOString().split('T')[0];

        } catch (err) { showError('Error: ' + err.message); }
      }

      function populateFilters() {
        var typeOpts = '<option value="">All Types</option>' + teaTypes.map(function(t) { return '<option value="' + t + '">' + t + '</option>'; }).join('');
        var companyOpts = '<option value="">All Companies</option>' + companies.map(function(c) { return '<option value="' + c.id + '">' + c.name + '</option>'; }).join('');
        
        ['totd-type', 'collection-tea-type'].forEach(function(id) { document.getElementById(id).innerHTML = typeOpts; });
        ['totd-company', 'collection-tea-company'].forEach(function(id) { document.getElementById(id).innerHTML = companyOpts; });
      }

      function populateCompanySelect() {
        var select = document.getElementById('featured-company');
        select.innerHTML = '<option value="">Select a company...</option>' + 
          companies.map(function(c) { return '<option value="' + c.id + '">' + c.name + '</option>'; }).join('');
      }

      // Collections
      document.getElementById('new-collection-btn').onclick = function() {
        document.getElementById('collection-form-title').textContent = 'New Collection';
        document.getElementById('collection-edit-id').value = '';
        document.getElementById('collection-title').value = '';
        document.getElementById('collection-subtitle').value = '';
        document.getElementById('collection-icon').value = '';
        document.getElementById('collection-form').classList.remove('hidden');
      };
      document.getElementById('cancel-collection-btn').onclick = function() {
        document.getElementById('collection-form').classList.add('hidden');
      };
      document.getElementById('save-collection-btn').onclick = async function() {
        var title = document.getElementById('collection-title').value;
        var subtitle = document.getElementById('collection-subtitle').value;
        var icon = document.getElementById('collection-icon').value;
        var editId = document.getElementById('collection-edit-id').value;

        if (!title) { showToast('Title required'); return; }

        var data = { title: title, subtitle: subtitle, icon_name: icon, icon_type: 'feather' };
        var result;
        if (editId) {
          result = await supabase.from('collections').update(data).eq('id', editId);
        } else {
          result = await supabase.from('collections').insert(data);
        }

        if (result.error) { showToast('Error: ' + result.error.message); }
        else { showToast(editId ? 'Updated!' : 'Created!'); document.getElementById('collection-form').classList.add('hidden'); init(); }
      };

      function renderCollections(data) {
        var tbody = document.querySelector('#collections-table tbody');
        if (!data.length) { tbody.innerHTML = '<tr><td colspan="5">No collections yet</td></tr>'; return; }
        tbody.innerHTML = data.map(function(c) {
          var teaCount = (c.collection_teas || []).length;
          return '<tr>' +
            '<td>' + c.title + '</td>' +
            '<td>' + (c.subtitle || '-') + '</td>' +
            '<td>' + teaCount + ' teas</td>' +
            '<td><span class="badge ' + (c.is_active ? 'badge-success' : 'badge-warning') + '">' + (c.is_active ? 'Active' : 'Inactive') + '</span></td>' +
            '<td>' +
              '<button class="btn btn-small" data-manage-teas="' + c.id + '" data-title="' + c.title + '">Manage Teas</button> ' +
              '<button class="btn btn-small btn-secondary" data-edit-collection="' + c.id + '">Edit</button> ' +
              '<button class="btn btn-small btn-secondary" data-toggle-collection="' + c.id + '" data-active="' + !c.is_active + '">' + (c.is_active ? 'Disable' : 'Enable') + '</button> ' +
              '<button class="btn btn-small btn-danger" data-delete-collection="' + c.id + '">Delete</button>' +
            '</td></tr>';
        }).join('');

        tbody.querySelectorAll('[data-edit-collection]').forEach(function(btn) {
          btn.onclick = function() { editCollection(this.getAttribute('data-edit-collection')); };
        });
        tbody.querySelectorAll('[data-toggle-collection]').forEach(function(btn) {
          btn.onclick = function() { toggleCollection(this.getAttribute('data-toggle-collection'), this.getAttribute('data-active') === 'true'); };
        });
        tbody.querySelectorAll('[data-delete-collection]').forEach(function(btn) {
          btn.onclick = function() { deleteCollection(this.getAttribute('data-delete-collection')); };
        });
        tbody.querySelectorAll('[data-manage-teas]').forEach(function(btn) {
          btn.onclick = function() { openCollectionTeas(this.getAttribute('data-manage-teas'), this.getAttribute('data-title')); };
        });
      }

      async function editCollection(id) {
        var result = await supabase.from('collections').select('*').eq('id', id).single();
        if (result.data) {
          document.getElementById('collection-form-title').textContent = 'Edit Collection';
          document.getElementById('collection-edit-id').value = id;
          document.getElementById('collection-title').value = result.data.title;
          document.getElementById('collection-subtitle').value = result.data.subtitle || '';
          document.getElementById('collection-icon').value = result.data.icon_name || '';
          document.getElementById('collection-form').classList.remove('hidden');
        }
      }

      async function toggleCollection(id, active) {
        await supabase.from('collections').update({ is_active: active }).eq('id', id);
        init();
      }

      async function deleteCollection(id) {
        if (confirm('Delete this collection?')) {
          await supabase.from('collections').delete().eq('id', id);
          init();
        }
      }

      // Collection Teas Management
      var currentCollectionId = null;

      async function openCollectionTeas(id, title) {
        currentCollectionId = id;
        document.getElementById('collection-teas-id').value = id;
        document.getElementById('collection-teas-title').textContent = title;
        document.getElementById('collection-teas-panel').classList.remove('hidden');
        await loadCollectionTeas();
        searchCollectionTeas();
      }

      document.getElementById('close-collection-teas-btn').onclick = function() {
        document.getElementById('collection-teas-panel').classList.add('hidden');
        init();
      };

      async function loadCollectionTeas() {
        var result = await supabase.from('collection_teas').select('*, teas(id, name, type, companies(name))').eq('collection_id', currentCollectionId).order('sort_order');
        var container = document.getElementById('collection-current-teas');
        var teas = result.data || [];
        if (!teas.length) { container.innerHTML = '<p style="color:#666;">No teas in this collection yet.</p>'; return; }
        container.innerHTML = teas.map(function(ct) {
          var tea = ct.teas;
          return '<div class="collection-tea-item">' +
            '<span>' + tea.name + ' <span style="color:#666;">(' + (tea.type || 'Unknown') + ' ‚Ä¢ ' + (tea.companies ? tea.companies.name : '') + ')</span></span>' +
            '<button class="btn btn-small btn-danger" data-remove-tea="' + ct.id + '">Remove</button></div>';
        }).join('');
        container.querySelectorAll('[data-remove-tea]').forEach(function(btn) {
          btn.onclick = async function() {
            await supabase.from('collection_teas').delete().eq('id', this.getAttribute('data-remove-tea'));
            loadCollectionTeas();
            showToast('Tea removed');
          };
        });
      }

      document.getElementById('collection-tea-search').oninput = searchCollectionTeas;
      document.getElementById('collection-tea-type').onchange = searchCollectionTeas;
      document.getElementById('collection-tea-company').onchange = searchCollectionTeas;

      async function searchCollectionTeas() {
        var query = document.getElementById('collection-tea-search').value.toLowerCase();
        var type = document.getElementById('collection-tea-type').value;
        var company = document.getElementById('collection-tea-company').value;

        var filtered = allTeas.filter(function(t) {
          if (query && t.name.toLowerCase().indexOf(query) === -1) return false;
          if (type && t.type !== type) return false;
          if (company && t.company_id !== company) return false;
          return true;
        }).slice(0, 50);

        var container = document.getElementById('collection-tea-results');
        if (!filtered.length) { container.innerHTML = '<p style="padding:15px;color:#666;">No teas found</p>'; return; }

        container.innerHTML = filtered.map(function(t) {
          var comp = companies.find(function(c) { return c.id === t.company_id; });
          return '<div class="tea-result" data-add-tea="' + t.id + '">' +
            '<div class="tea-info"><div class="tea-name">' + t.name + '</div>' +
            '<div class="tea-meta">' + (t.type || 'Unknown') + ' ‚Ä¢ ' + (comp ? comp.name : '') + '</div></div>' +
            '<button class="btn btn-small">Add</button></div>';
        }).join('');

        container.querySelectorAll('[data-add-tea]').forEach(function(el) {
          el.onclick = async function() {
            var teaId = this.getAttribute('data-add-tea');
            var result = await supabase.from('collection_teas').insert({ collection_id: currentCollectionId, tea_id: teaId });
            if (result.error) { showToast('Error: ' + result.error.message); }
            else { showToast('Tea added!'); loadCollectionTeas(); }
          };
        });
      }

      // Featured Shops
      document.getElementById('new-featured-btn').onclick = function() {
        document.getElementById('featured-form').classList.remove('hidden');
      };
      document.getElementById('cancel-featured-btn').onclick = function() {
        document.getElementById('featured-form').classList.add('hidden');
      };
      document.getElementById('save-featured-btn').onclick = async function() {
        var company_id = document.getElementById('featured-company').value;
        var start_date = document.getElementById('featured-start').value;
        var end_date = document.getElementById('featured-end').value;
        var is_exclusive = document.getElementById('featured-exclusive').checked;

        if (!company_id || !start_date || !end_date) { showToast('All fields required'); return; }

        var result = await supabase.from('featured_shops').insert({ company_id: company_id, start_date: start_date, end_date: end_date, is_exclusive: is_exclusive });
        if (result.error) { showToast('Error: ' + result.error.message); }
        else { showToast('Added!'); document.getElementById('featured-form').classList.add('hidden'); init(); }
      };

      function renderFeatured(data) {
        var tbody = document.querySelector('#featured-table tbody');
        if (!data.length) { tbody.innerHTML = '<tr><td colspan="5">No featured shops yet</td></tr>'; return; }
        var today = new Date().toISOString().split('T')[0];
        tbody.innerHTML = data.map(function(f) {
          var isActive = f.is_active && f.start_date <= today && f.end_date >= today;
          var name = f.companies ? f.companies.name : 'Unknown';
          return '<tr><td>' + name + '</td><td>' + f.start_date + ' ‚Üí ' + f.end_date + '</td>' +
            '<td>' + (f.is_exclusive ? '‚úì' : '-') + '</td>' +
            '<td><span class="badge ' + (isActive ? 'badge-success' : 'badge-warning') + '">' + (isActive ? 'Active' : 'Scheduled') + '</span></td>' +
            '<td><button class="btn btn-small btn-danger" data-delete-featured="' + f.id + '">Delete</button></td></tr>';
        }).join('');

        tbody.querySelectorAll('[data-delete-featured]').forEach(function(btn) {
          btn.onclick = async function() {
            if (confirm('Delete?')) { await supabase.from('featured_shops').delete().eq('id', this.getAttribute('data-delete-featured')); init(); }
          };
        });
      }

      // Tea of the Day
      document.getElementById('totd-date').onchange = loadTotd;
      document.getElementById('totd-search').oninput = searchTotd;
      document.getElementById('totd-type').onchange = searchTotd;
      document.getElementById('totd-company').onchange = searchTotd;
      document.getElementById('totd-caffeine').onchange = searchTotd;

      async function loadTotd() {
        var date = document.getElementById('totd-date').value;
        var result = await supabase.from('tea_of_the_day').select('*, teas(name)').eq('featured_date', date).single();
        document.getElementById('totd-tea-name').textContent = (result.data && result.data.teas) ? result.data.teas.name : 'None set';
      }

      async function searchTotd() {
        var query = document.getElementById('totd-search').value.toLowerCase();
        var type = document.getElementById('totd-type').value;
        var company = document.getElementById('totd-company').value;
        var caffeine = document.getElementById('totd-caffeine').value;

        var filtered = allTeas.filter(function(t) {
          if (query && t.name.toLowerCase().indexOf(query) === -1) return false;
          if (type && t.type !== type) return false;
          if (company && t.company_id !== company) return false;
          if (caffeine && t.caffeine_level !== caffeine) return false;
          return true;
        }).slice(0, 50);

        var container = document.getElementById('totd-results');
        if (!query && !type && !company && !caffeine) { container.innerHTML = '<p style="padding:15px;color:#666;">Use the filters above to find a tea</p>'; return; }
        if (!filtered.length) { container.innerHTML = '<p style="padding:15px;color:#666;">No teas found</p>'; return; }

        container.innerHTML = filtered.map(function(t) {
          var comp = companies.find(function(c) { return c.id === t.company_id; });
          return '<div class="tea-result" data-set-totd="' + t.id + '" data-name="' + t.name.replace(/"/g, '&quot;') + '">' +
            '<div class="tea-info"><div class="tea-name">' + t.name + '</div>' +
            '<div class="tea-meta">' + (t.type || 'Unknown') + ' ‚Ä¢ ' + (comp ? comp.name : '') + (t.caffeine_level ? ' ‚Ä¢ ' + t.caffeine_level + ' caffeine' : '') + '</div></div>' +
            '<button class="btn btn-small">Select</button></div>';
        }).join('');

        container.querySelectorAll('[data-set-totd]').forEach(function(el) {
          el.onclick = async function() {
            var teaId = this.getAttribute('data-set-totd');
            var teaName = this.getAttribute('data-name');
            var date = document.getElementById('totd-date').value;
            var result = await supabase.from('tea_of_the_day').upsert({ tea_id: teaId, featured_date: date, is_manual: true }, { onConflict: 'featured_date' });
            if (result.error) { showToast('Error: ' + result.error.message); }
            else { showToast('Set "' + teaName + '" as Tea of the Day!'); document.getElementById('totd-tea-name').textContent = teaName; }
          };
        });
      }

      init();
    });
  </script>
</body>
</html>
